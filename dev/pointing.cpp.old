#include <nanobind/nanobind.h>
#include <nanobind/ndarray.h>
#include <nanobind/stl/array.h>
#include <nanobind/stl/tuple.h>

#include <stdio.h>
#include <stdlib.h>

#include <math.h>
#include <assert.h>
#include <cmath>
#include <chrono>
#include <time.h>

// #include "pointing.h"
#include "kernel_params.h"

#include <cuda.h>
#include <cuda_runtime_api.h>
#include <cuda_device_runtime_api.h>

namespace nb = nanobind;
using namespace nb::literals;


void float_to_double(const float* src, double* dest, int size) {
    for (int i = 0; i < size; i++) {
        dest[i] = (double)src[i];
    }
}

std::tuple<intptr_t, intptr_t> Cpointing_ptrs(intptr_t thetas_, intptr_t phi0_, intptr_t nphis_, intptr_t ringstarts_, intptr_t synthmap_, int nring, int npix, double *host_result){
    printf("pointing.cpp:: Cpointing_ptrs\n");
    KernelParams kp;
    kp.thetas = reinterpret_cast<double*>(thetas_);
    kp.phi0 = reinterpret_cast<double*>(phi0_);
    kp.nphis = reinterpret_cast<int*>(nphis_);
    kp.ringstarts = reinterpret_cast<int*>(ringstarts_);
    kp.synthmap = reinterpret_cast<double*>(synthmap_);
    kp.nring = nring;
    kp.npix = npix;

    auto devres = CUpointing_struct(kp);
    return std::make_tuple(reinterpret_cast<intptr_t>(std::get<0>(devres)),reinterpret_cast<intptr_t>(std::get<1>(devres)));
}


void CUfloat_to_double(const float* src, double* dest, int size) {
    for (int i = 0; i < size; i++) {
        dest[i] = (double)src[i];
    }
}


NB_MODULE(popy, m) {
    m.def(
        "Cpointing_ptrs",
        [](
            intptr_t thetas_,
            intptr_t phi0_,
            intptr_t nphis_,
            intptr_t ringstarts_,
            intptr_t synthmap_,
            int nring,
            int npix,
            nb::ndarray<double>&host_result
            ) {
            return Cpointing_ptrs(thetas_, phi0_, nphis_, ringstarts_, synthmap_, nring, npix, host_result.data());
        }
    );
}